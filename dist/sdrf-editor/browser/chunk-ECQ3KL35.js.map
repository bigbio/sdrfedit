{
  "version": 3,
  "sources": ["src/app/core/services/llm/providers/anthropic-provider.ts"],
  "sourcesContent": ["/**\n * Anthropic LLM Provider\n *\n * Implements the Anthropic Messages API with streaming support.\n * https://docs.anthropic.com/en/api/messages\n */\n\nimport {\n  LlmProviderType,\n  LlmProviderConfig,\n  LlmMessage,\n  LlmResponse,\n  LlmStreamChunk,\n  LlmUsage,\n} from '../../../models/llm';\nimport { BaseLlmProvider } from './base-provider';\n\n/**\n * Anthropic message format.\n */\ninterface AnthropicMessage {\n  role: 'user' | 'assistant';\n  content: string;\n}\n\n/**\n * Anthropic Messages API request body.\n */\ninterface AnthropicRequest {\n  model: string;\n  messages: AnthropicMessage[];\n  system?: string;\n  max_tokens: number;\n  temperature?: number;\n  stream?: boolean;\n}\n\n/**\n * Anthropic Messages API response.\n */\ninterface AnthropicResponse {\n  id: string;\n  type: 'message';\n  role: 'assistant';\n  content: Array<{\n    type: 'text';\n    text: string;\n  }>;\n  model: string;\n  stop_reason: 'end_turn' | 'max_tokens' | 'stop_sequence' | null;\n  stop_sequence: string | null;\n  usage: {\n    input_tokens: number;\n    output_tokens: number;\n  };\n}\n\n/**\n * Anthropic streaming event types.\n */\ninterface AnthropicStreamEvent {\n  type: 'message_start' | 'content_block_start' | 'content_block_delta' | 'content_block_stop' | 'message_delta' | 'message_stop';\n  message?: Partial<AnthropicResponse>;\n  index?: number;\n  content_block?: { type: 'text'; text: string };\n  delta?: {\n    type: 'text_delta';\n    text: string;\n  } | {\n    stop_reason: string;\n    stop_sequence: string | null;\n  };\n  usage?: {\n    output_tokens: number;\n  };\n}\n\n/**\n * Anthropic LLM Provider implementation.\n */\nexport class AnthropicProvider extends BaseLlmProvider {\n  readonly name: LlmProviderType = 'anthropic';\n  readonly supportsStreaming = true;\n\n  private static readonly API_VERSION = '2023-06-01';\n\n  constructor(config: Partial<LlmProviderConfig> = {}) {\n    super(config);\n  }\n\n  protected getProviderType(): LlmProviderType {\n    return 'anthropic';\n  }\n\n  /**\n   * Sends a completion request to Anthropic.\n   */\n  async complete(messages: LlmMessage[]): Promise<LlmResponse> {\n    this.validateConfiguration();\n\n    const url = `${this.config.baseUrl}/messages`;\n    const { system, convertedMessages } = this.convertMessages(messages);\n\n    const body: AnthropicRequest = {\n      model: this.config.model,\n      messages: convertedMessages,\n      max_tokens: this.config.maxTokens || 4096,\n      temperature: this.config.temperature,\n      stream: false,\n    };\n\n    if (system) {\n      body.system = system;\n    }\n\n    const response = await this.fetchWithTimeout(url, {\n      method: 'POST',\n      headers: this.getHeaders(),\n      body: JSON.stringify(body),\n    });\n\n    if (!response.ok) {\n      const errorBody = await response.text();\n      throw this.createErrorFromResponse(response.status, errorBody);\n    }\n\n    const data: AnthropicResponse = await response.json();\n    return this.convertResponse(data);\n  }\n\n  /**\n   * Streams a completion from Anthropic.\n   */\n  async *stream(messages: LlmMessage[]): AsyncGenerator<LlmStreamChunk, void, unknown> {\n    this.validateConfiguration();\n\n    const url = `${this.config.baseUrl}/messages`;\n    const { system, convertedMessages } = this.convertMessages(messages);\n\n    const body: AnthropicRequest = {\n      model: this.config.model,\n      messages: convertedMessages,\n      max_tokens: this.config.maxTokens || 4096,\n      temperature: this.config.temperature,\n      stream: true,\n    };\n\n    if (system) {\n      body.system = system;\n    }\n\n    const reader = await this.fetchStream(url, {\n      method: 'POST',\n      headers: this.getHeaders(),\n      body: JSON.stringify(body),\n    });\n\n    for await (const data of this.parseSSEStream(reader)) {\n      try {\n        const event: AnthropicStreamEvent = JSON.parse(data);\n\n        if (event.type === 'content_block_delta' && event.delta) {\n          const delta = event.delta as { type: 'text_delta'; text: string };\n          if (delta.type === 'text_delta') {\n            yield {\n              content: delta.text,\n              done: false,\n            };\n          }\n        } else if (event.type === 'message_delta' && event.delta) {\n          const delta = event.delta as { stop_reason: string };\n          if (delta.stop_reason) {\n            yield {\n              content: '',\n              done: true,\n              finishReason: delta.stop_reason,\n            };\n          }\n        } else if (event.type === 'message_stop') {\n          yield {\n            content: '',\n            done: true,\n          };\n        }\n      } catch (e) {\n        // Skip malformed events\n        console.warn('Failed to parse Anthropic stream event:', data, e);\n      }\n    }\n  }\n\n  // ============ Private Methods ============\n\n  /**\n   * Gets request headers including authorization.\n   */\n  private getHeaders(): Record<string, string> {\n    return {\n      ...this.getCommonHeaders(),\n      'x-api-key': this.config.apiKey || '',\n      'anthropic-version': AnthropicProvider.API_VERSION,\n    };\n  }\n\n  /**\n   * Converts our message format to Anthropic format.\n   * Extracts system message separately as Anthropic uses a different format.\n   */\n  private convertMessages(messages: LlmMessage[]): {\n    system: string | undefined;\n    convertedMessages: AnthropicMessage[];\n  } {\n    let system: string | undefined;\n    const convertedMessages: AnthropicMessage[] = [];\n\n    for (const msg of messages) {\n      if (msg.role === 'system') {\n        // Anthropic uses a separate system parameter\n        system = system ? `${system}\\n\\n${msg.content}` : msg.content;\n      } else {\n        convertedMessages.push({\n          role: msg.role as 'user' | 'assistant',\n          content: msg.content,\n        });\n      }\n    }\n\n    // Ensure conversation starts with user message\n    if (convertedMessages.length > 0 && convertedMessages[0].role !== 'user') {\n      convertedMessages.unshift({\n        role: 'user',\n        content: 'Please proceed with your analysis.',\n      });\n    }\n\n    return { system, convertedMessages };\n  }\n\n  /**\n   * Converts Anthropic response to our format.\n   */\n  private convertResponse(data: AnthropicResponse): LlmResponse {\n    // Extract text content\n    const textContent = data.content\n      .filter((c) => c.type === 'text')\n      .map((c) => c.text)\n      .join('');\n\n    const usage: LlmUsage | undefined = data.usage\n      ? {\n          promptTokens: data.usage.input_tokens,\n          completionTokens: data.usage.output_tokens,\n          totalTokens: data.usage.input_tokens + data.usage.output_tokens,\n        }\n      : undefined;\n\n    return {\n      content: textContent,\n      finishReason: this.mapFinishReason(data.stop_reason),\n      usage,\n      raw: data,\n    };\n  }\n\n  /**\n   * Maps Anthropic stop reasons to our standard format.\n   */\n  private mapFinishReason(\n    reason: string | null\n  ): 'stop' | 'length' | 'content_filter' | 'error' | undefined {\n    switch (reason) {\n      case 'end_turn':\n      case 'stop_sequence':\n        return 'stop';\n      case 'max_tokens':\n        return 'length';\n      default:\n        return undefined;\n    }\n  }\n}\n\n/**\n * Factory function to create an Anthropic provider.\n */\nexport function createAnthropicProvider(\n  config?: Partial<LlmProviderConfig>\n): AnthropicProvider {\n  return new AnthropicProvider(config);\n}\n"],
  "mappings": "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",
  "names": []
}
