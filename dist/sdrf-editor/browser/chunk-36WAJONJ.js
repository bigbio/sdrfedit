import{d as i,k as y}from"./chunk-FIWRXBYQ.js";import{f as a,g as m,h as f}from"./chunk-KAWQVD33.js";var p=class extends y{name="ollama";supportsStreaming=!0;constructor(e={}){super(e)}getProviderType(){return"ollama"}isConfigured(){return!0}complete(e){return a(this,null,function*(){let r=`${this.config.baseUrl}/api/chat`,n={model:this.config.model,messages:this.convertMessages(e),stream:!1,options:{temperature:this.config.temperature,num_predict:this.config.maxTokens}};try{let t=yield this.fetchWithTimeout(r,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(n)});if(!t.ok){let u=yield t.text();throw this.createErrorFromResponse(t.status,u)}let c=yield t.json();return this.convertResponse(c)}catch(t){throw t instanceof TypeError&&t.message.includes("fetch")?new i("Cannot connect to Ollama. Make sure Ollama is running on "+this.config.baseUrl,"NETWORK_ERROR","ollama"):t}})}stream(e){return f(this,null,function*(){let r=`${this.config.baseUrl}/api/chat`,n={model:this.config.model,messages:this.convertMessages(e),stream:!0,options:{temperature:this.config.temperature,num_predict:this.config.maxTokens}};this.abortController=new AbortController;try{let t=yield new m(fetch(r,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(n),signal:this.abortController.signal}));if(!t.ok){let l=yield new m(t.text());throw this.createErrorFromResponse(t.status,l)}if(!t.body)throw new Error("Response body is empty");let c=t.body.getReader(),u=new TextDecoder,o="";for(;;){let{done:l,value:b}=yield new m(c.read());if(l)break;o+=u.decode(b,{stream:!0});let g=o.split(`
`);o=g.pop()||"";for(let R of g){let d=R.trim();if(d)try{let s=JSON.parse(d);yield{content:s.message?.content||"",done:s.done,finishReason:s.done?"stop":void 0}}catch(s){console.warn("Failed to parse Ollama stream chunk:",d,s)}}}if(o.trim())try{yield{content:JSON.parse(o.trim()).message?.content||"",done:!0,finishReason:"stop"}}catch{}}catch(t){throw t instanceof TypeError&&t.message.includes("fetch")?new i("Cannot connect to Ollama. Make sure Ollama is running.","NETWORK_ERROR","ollama"):t instanceof Error&&t.name==="AbortError"?new i("Request was cancelled","ABORTED","ollama"):t}})}listModels(){return a(this,null,function*(){try{let e=yield fetch(`${this.config.baseUrl}/api/tags`,{headers:this.getHeaders()});return e.ok?((yield e.json()).models||[]).map(n=>n.name):[]}catch{return[]}})}isRunning(){return a(this,null,function*(){try{return(yield fetch(`${this.config.baseUrl}/api/tags`,{signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}})}pullModel(e){return a(this,null,function*(){let r=yield fetch(`${this.config.baseUrl}/api/pull`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({name:e,stream:!1})});if(!r.ok){let n=yield r.text();throw new i(`Failed to pull model ${e}: ${n}`,"PROVIDER_ERROR","ollama")}})}getHeaders(){return{"Content-Type":"application/json"}}convertMessages(e){return e.map(r=>({role:r.role,content:r.content}))}convertResponse(e){let r=e.prompt_eval_count!==void 0||e.eval_count!==void 0?{promptTokens:e.prompt_eval_count||0,completionTokens:e.eval_count||0,totalTokens:(e.prompt_eval_count||0)+(e.eval_count||0)}:void 0;return{content:e.message?.content||"",finishReason:e.done?"stop":void 0,usage:r,raw:e}}};function P(h){return new p(h)}export{p as OllamaProvider,P as createOllamaProvider};
