import{l as R}from"./chunk-PX34FNJO.js";import{f as C,g as u,h as b}from"./chunk-KAWQVD33.js";var f=class extends R{name="gemini";supportsStreaming=!0;constructor(e={}){super(e)}getProviderType(){return"gemini"}complete(e){return C(this,null,function*(){this.validateConfiguration();let n=this.buildUrl("generateContent"),i=this.buildRequestBody(e),t=yield this.fetchWithTimeout(n,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(i)});if(!t.ok){let l=yield t.text();throw this.createErrorFromResponse(t.status,l)}let r=yield t.json();return this.convertResponse(r)})}stream(e){return b(this,null,function*(){this.validateConfiguration();let n=this.buildUrl("streamGenerateContent"),i=this.buildRequestBody(e);this.abortController=new AbortController;let t=setTimeout(()=>{this.abortController?.abort()},this.config.timeoutMs||6e4);try{let r=yield new u(fetch(n,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(i),signal:this.abortController.signal}));if(!r.ok){let s=yield new u(r.text());throw this.createErrorFromResponse(r.status,s)}if(!r.body)throw new Error("Response body is empty");let l=r.body.getReader(),k=new TextDecoder,m="";for(;;){let{done:s,value:g}=yield new u(l.read());if(s)break;m+=k.decode(g,{stream:!0});let c=m.split(`
`);m=c.pop()||"";for(let y of c){let a=y.trim();if(!a||a==="["||a==="]"||a===",")continue;let o=a;if(o.startsWith("[")&&(o=o.slice(1)),o.endsWith("]")&&(o=o.slice(0,-1)),o.endsWith(",")&&(o=o.slice(0,-1)),!!o.trim())try{let d=JSON.parse(o).candidates?.[0];d?.content?.parts&&(yield{content:d.content.parts.filter(p=>p.text).map(p=>p.text).join(""),done:!!d.finishReason,finishReason:d.finishReason||void 0})}catch(T){console.warn("Failed to parse Gemini stream chunk:",o,T)}}}if(m.trim())try{let s=m.trim();if(s.endsWith("]")&&(s=s.slice(0,-1)),s.endsWith(",")&&(s=s.slice(0,-1)),s){let c=JSON.parse(s).candidates?.[0];c?.content?.parts&&(yield{content:c.content.parts.filter(a=>a.text).map(a=>a.text).join(""),done:!0,finishReason:c.finishReason||"STOP"})}}catch{}}finally{clearTimeout(t)}})}buildUrl(e){let n=this.config.model,i=this.config.apiKey;return`${this.config.baseUrl}/models/${n}:${e}?key=${i}`}getHeaders(){return{"Content-Type":"application/json"}}buildRequestBody(e){let{system:n,contents:i}=this.convertMessages(e),t={contents:i,generationConfig:{temperature:this.config.temperature,maxOutputTokens:this.config.maxTokens}};return n&&(t.systemInstruction={parts:[{text:n}]}),t}convertMessages(e){let n,i=[];for(let t of e)t.role==="system"?n=n?`${n}

${t.content}`:t.content:i.push({role:t.role==="assistant"?"model":"user",parts:[{text:t.content}]});return i.length>0&&i[0].role!=="user"&&i.unshift({role:"user",parts:[{text:"Please proceed with your analysis."}]}),{system:n,contents:i}}convertResponse(e){let n=e.candidates?.[0],i=n?.content?.parts?.filter(r=>r.text).map(r=>r.text).join("")||"",t=e.usageMetadata?{promptTokens:e.usageMetadata.promptTokenCount,completionTokens:e.usageMetadata.candidatesTokenCount,totalTokens:e.usageMetadata.totalTokenCount}:void 0;return{content:i,finishReason:this.mapFinishReason(n?.finishReason),usage:t,raw:e}}mapFinishReason(e){switch(e){case"STOP":return"stop";case"MAX_TOKENS":return"length";case"SAFETY":case"RECITATION":return"content_filter";default:return}}};function v(h){return new f(h)}export{f as GeminiProvider,v as createGeminiProvider};
