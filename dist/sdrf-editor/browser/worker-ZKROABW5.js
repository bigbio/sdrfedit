var w={openai:{model:"gpt-4o-mini",baseUrl:"https://api.openai.com/v1",timeoutMs:6e4,maxTokens:4096,temperature:.3},anthropic:{model:"claude-sonnet-4-20250514",baseUrl:"https://api.anthropic.com/v1",timeoutMs:6e4,maxTokens:4096,temperature:.3},gemini:{model:"gemini-2.0-flash",baseUrl:"https://generativelanguage.googleapis.com/v1beta",timeoutMs:6e4,maxTokens:4096,temperature:.3},ollama:{model:"qwen3",baseUrl:"http://localhost:11434",timeoutMs:12e4,maxTokens:4096,temperature:.3}},h=new Map;async function*x(e,t,a){let l=`${e.baseUrl}/chat/completions`,o=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:t.map(i=>({role:i.role,content:i.content})),max_tokens:e.maxTokens,temperature:e.temperature,stream:!0}),signal:a});if(!o.ok){let i=await o.text();throw new Error(`OpenAI API error (${o.status}): ${i}`)}let r=o.body.getReader(),d=new TextDecoder,c="";try{for(;;){let{done:i,value:y}=await r.read();if(i)break;c+=d.decode(y,{stream:!0});let m=c.split(`
`);c=m.pop()||"";for(let s of m){let p=s.trim();if(!(!p||p.startsWith(":"))&&p.startsWith("data: ")){let u=p.slice(6);if(u==="[DONE]")return;try{let n=JSON.parse(u).choices?.[0]?.delta?.content;n&&(yield n)}catch{}}}}}finally{r.releaseLock()}}async function*v(e,t,a){let l=`${e.baseUrl}/messages`,o,r=[];for(let s of t)s.role==="system"?o=o?`${o}

${s.content}`:s.content:r.push({role:s.role,content:s.content});r.length>0&&r[0].role!=="user"&&r.unshift({role:"user",content:"Please proceed with your analysis."});let d={model:e.model,messages:r,max_tokens:e.maxTokens||4096,temperature:e.temperature,stream:!0};o&&(d.system=o);let c=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":e.apiKey||"","anthropic-version":"2023-06-01"},body:JSON.stringify(d),signal:a});if(!c.ok){let s=await c.text();throw new Error(`Anthropic API error (${c.status}): ${s}`)}let i=c.body.getReader(),y=new TextDecoder,m="";try{for(;;){let{done:s,value:p}=await i.read();if(s)break;m+=y.decode(p,{stream:!0});let u=m.split(`
`);m=u.pop()||"";for(let g of u){let n=g.trim();if(!(!n||n.startsWith(":"))&&n.startsWith("data: ")){let k=n.slice(6);try{let f=JSON.parse(k);f.type==="content_block_delta"&&f.delta?.type==="text_delta"&&(yield f.delta.text)}catch{}}}}}finally{i.releaseLock()}}async function*T(e,t,a){let l,o=[];for(let s of t)s.role==="system"?l=l?`${l}

${s.content}`:s.content:o.push({role:s.role==="assistant"?"model":"user",parts:[{text:s.content}]});o.length>0&&o[0].role!=="user"&&o.unshift({role:"user",parts:[{text:"Please proceed with your analysis."}]});let r={contents:o,generationConfig:{temperature:e.temperature,maxOutputTokens:e.maxTokens}};l&&(r.systemInstruction={parts:[{text:l}]});let d=`${e.baseUrl}/models/${e.model}:streamGenerateContent?key=${e.apiKey}`,c=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:a});if(!c.ok){let s=await c.text();throw new Error(`Gemini API error (${c.status}): ${s}`)}let i=c.body.getReader(),y=new TextDecoder,m="";try{for(;;){let{done:s,value:p}=await i.read();if(s)break;m+=y.decode(p,{stream:!0});let u=m.split(`
`);m=u.pop()||"";for(let g of u){let n=g.trim();if(!(!n||n==="["||n==="]"||n===",")&&(n.startsWith("[")&&(n=n.slice(1)),n.endsWith("]")&&(n=n.slice(0,-1)),n.endsWith(",")&&(n=n.slice(0,-1)),!!n.trim()))try{let f=JSON.parse(n).candidates?.[0]?.content?.parts?.filter(b=>b.text).map(b=>b.text).join("");f&&(yield f)}catch{}}}}finally{i.releaseLock()}}async function*P(e,t,a){let l=`${e.baseUrl}/api/chat`,o=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:e.model,messages:t.map(i=>({role:i.role,content:i.content})),stream:!0,options:{temperature:e.temperature,num_predict:e.maxTokens}}),signal:a});if(!o.ok){let i=await o.text();throw new Error(`Ollama API error (${o.status}): ${i}`)}let r=o.body.getReader(),d=new TextDecoder,c="";try{for(;;){let{done:i,value:y}=await r.read();if(i)break;c+=d.decode(y,{stream:!0});let m=c.split(`
`);c=m.pop()||"";for(let s of m){let p=s.trim();if(p)try{let u=JSON.parse(p);u.message?.content&&(yield u.message.content)}catch{}}}}finally{r.releaseLock()}}async function*A(e,t){let a={...w[e.provider],...e.config};switch(e.provider){case"openai":yield*x(a,e.messages,t);break;case"anthropic":yield*v(a,e.messages,t);break;case"gemini":yield*T(a,e.messages,t);break;case"ollama":yield*P(a,e.messages,t);break;default:throw new Error(`Unknown provider: ${e.provider}`)}}async function L(e,t){let a="";for await(let l of A(e,t))a+=l;return a}addEventListener("message",async e=>{let t=e.data;if(t.type==="abort"){let r=h.get(t.id);r&&(r.abort(),h.delete(t.id));return}let a=new AbortController;h.set(t.id,a);let l=t.config.timeoutMs||w[t.provider].timeoutMs||6e4,o=setTimeout(()=>{a.abort()},l);try{if(t.type==="stream"){let r="";for await(let d of A(t,a.signal))r+=d,postMessage({id:t.id,type:"chunk",content:d});postMessage({id:t.id,type:"complete",content:r})}else{let r=await L(t,a.signal);postMessage({id:t.id,type:"complete",content:r})}}catch(r){let d=r instanceof Error?r.message:String(r);d.includes("abort")||r instanceof Error&&r.name==="AbortError"?postMessage({id:t.id,type:"aborted",error:"Request was aborted"}):postMessage({id:t.id,type:"error",error:d})}finally{clearTimeout(o),h.delete(t.id)}});postMessage({id:"init",type:"complete",content:"AI Worker loaded"});
