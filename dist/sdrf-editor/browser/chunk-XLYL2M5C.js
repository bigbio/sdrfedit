import{k as y}from"./chunk-FIWRXBYQ.js";import{a as u,b as g,f as d,g as c,h,i as f}from"./chunk-KAWQVD33.js";var l=class p extends y{name="anthropic";supportsStreaming=!0;static API_VERSION="2023-06-01";constructor(e={}){super(e)}getProviderType(){return"anthropic"}complete(e){return d(this,null,function*(){this.validateConfiguration();let n=`${this.config.baseUrl}/messages`,{system:t,convertedMessages:s}=this.convertMessages(e),a={model:this.config.model,messages:s,max_tokens:this.config.maxTokens||4096,temperature:this.config.temperature,stream:!1};t&&(a.system=t);let r=yield this.fetchWithTimeout(n,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(a)});if(!r.ok){let v=yield r.text();throw this.createErrorFromResponse(r.status,v)}let _=yield r.json();return this.convertResponse(_)})}stream(e){return h(this,null,function*(){this.validateConfiguration();let n=`${this.config.baseUrl}/messages`,{system:t,convertedMessages:s}=this.convertMessages(e),a={model:this.config.model,messages:s,max_tokens:this.config.maxTokens||4096,temperature:this.config.temperature,stream:!0};t&&(a.system=t);let r=yield new c(this.fetchStream(n,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(a)}));try{for(var _=f(this.parseSSEStream(r)),v,b,L;v=!(b=yield new c(_.next())).done;v=!1){let m=b.value;try{let o=JSON.parse(m);if(o.type==="content_block_delta"&&o.delta){let i=o.delta;i.type==="text_delta"&&(yield{content:i.text,done:!1})}else if(o.type==="message_delta"&&o.delta){let i=o.delta;i.stop_reason&&(yield{content:"",done:!0,finishReason:i.stop_reason})}else o.type==="message_stop"&&(yield{content:"",done:!0})}catch(o){console.warn("Failed to parse Anthropic stream event:",m,o)}}}catch{L=[b]}finally{try{v&&(b=_.return)&&(yield new c(b.call(_)))}finally{if(L)throw L[0]}}})}getHeaders(){return g(u({},this.getCommonHeaders()),{"x-api-key":this.config.apiKey||"","anthropic-version":p.API_VERSION})}convertMessages(e){let n,t=[];for(let s of e)s.role==="system"?n=n?`${n}

${s.content}`:s.content:t.push({role:s.role,content:s.content});return t.length>0&&t[0].role!=="user"&&t.unshift({role:"user",content:"Please proceed with your analysis."}),{system:n,convertedMessages:t}}convertResponse(e){let n=e.content.filter(s=>s.type==="text").map(s=>s.text).join(""),t=e.usage?{promptTokens:e.usage.input_tokens,completionTokens:e.usage.output_tokens,totalTokens:e.usage.input_tokens+e.usage.output_tokens}:void 0;return{content:n,finishReason:this.mapFinishReason(e.stop_reason),usage:t,raw:e}}mapFinishReason(e){switch(e){case"end_turn":case"stop_sequence":return"stop";case"max_tokens":return"length";default:return}}};function x(p){return new l(p)}export{l as AnthropicProvider,x as createAnthropicProvider};
